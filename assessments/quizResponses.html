<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" type="text/css" href="../css/assessments/quiz.css" />
  <script type="text/javascript" src="../js/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="../js/d3.min.js"></script>
  <title>lrsDataCall</title>

  <script type="text/javascript">
    // Basic example of pulling data from the LRS
    window.onload = function() {

      let username = "",
        password = "";
      let URL = 'https://videocohort.lrs.io/xapi/statements/aggregate';

      var pipeline = [{
        $match: {
          $and: [{
              "statement.context.contextActivities.category.id": "https://w3id.org/xapi/scorm"
            }, // Grab only SCORM Profile compliant statements
            {
              "statement.context.contextActivities.parent.id": "https://jhaag75.github.io/xapi-cohort-video/quizes/gimpQuiz.html"
            } // Targeting specific quiz
          ]
        }
      }, {
        $group: {
          _id: {
            "quizQuestion": "$statement.object.definition.name.en-US"
          },
          question: {
            $last: "$statement.object.definition.description.en-US"
          },
          choices: {
            $last: "$statement.object.definition.choices"
          },
          correct: {
            $last: "$statement.object.definition.correctResponsesPattern"
          },
          answers: {
            $push: "$statement.result.response"
          },
          quizName: {
            $last: "$statement.context.contextActivities.parent.definition.name.en-US"
          }
        }
      }];

      $.ajaxSetup({
        type: "POST",
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Authorization", "Basic " + btoa(username + ":" + password));
          xhr.setRequestHeader("X-Experience-API-Version", "1.0.0");

        },
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        data: JSON.stringify(pipeline)

      });

      $.ajax({
        dataType: "json",
        url: URL,
        success: assessmentVis
      });
    }

    function assessmentVis(e) {

      // Order data prior to visualizations
      orderByQuestion(e);

      // Create body select, tooltip and site header
      const body = d3.select("body");
      const tooltip = body.append("div").attr("class", "toolTip");
      d3.select(".title").html(e[0].quizName[0]);


      // Some default size parameters
      const visHeaderHeight = 100,
        visItemHeight = 30;

      // Create SVG selector for the visualization and default parameters
      const svg = d3.select("svg"),
        margin = {
          top: 10,
          right: 50,
          bottom: 50,
          left: 50
        };

      svg.attr("width", 960)
        .attr("height", function() {
          return visHeaderHeight + (visItemHeight * e.length) + margin.top + margin.bottom;
        })

      const width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        vis = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Start Visualization
      // Create Header
      const visHeader = vis.append("rect")
        .attr("width", width)
        .attr("height", visHeaderHeight)
        .classed("visHeader", true);

      // Container element for all questions
      const visQuestions = vis.append("g")
        .attr("width", width)
        .attr("height", function() {
          return e.length * visItemHeight;
        })
        .attr("transform", "translate(0," + visHeaderHeight + ")")
        .classed("visQuestions", true);

      // Create background rect for all questions
      visQuestions.append("rect")
        .attr("width", width)
        .attr("height", function() {
          return e.length * visItemHeight;
        })
        .classed("visQuestionBg", true);

      // Create container elements for data on each question
      const visQuestion = visQuestions.selectAll("g")
        .data(e)
        .enter()
        .append("g")
        .attr("width", width)
        .attr("height", visItemHeight)
        .attr("y", function(d, i) {
          return (i * visItemHeight);
        })
        .classed("visItem", true);

      // Go through each container and add the question text and responses
      let questionWidth = 100;
      let answersWidth = width - questionWidth;

      visQuestion.each(function(d, i) {
        console.log(d);

        // Add response rects
        // Count number of responses, sort by count but make correct answer first
        const sortedAnswers = processAnswers(d.choices, d.answers, d.correct);

        // Draw rects
        const sum = sortedAnswers.reduce((a,b) => ({count: a.count + b.count}));
        const answerStep = answersWidth / sum.count;
        let nextPosition = questionWidth;


        d3.select(this).selectAll("rect")
          .data(sortedAnswers)
          .enter()
          .append("rect")
          .attr("width", function(d) {
            return d.count * answerStep;
          })
          .attr("height", visItemHeight)
          .attr("y", (i * visItemHeight))
          .attr("x", function(d, i) {
            let currentPos = nextPosition;
            nextPosition = currentPos + (d.count * answerStep);
            return currentPos;
          })
          .attr("class", function(d, i) {
            return (i === 0) ? "visAnswer correct" : "visAnswer incorrect";
          })
          .on("mousemove", function(d) {
            d3.select(this).attr("stroke", "black");
            tooltip
              .style("left", d3.event.pageX - 50 + "px")
              .style("top", d3.event.pageY - 70 + "px")
              .style("display", "inline-block")
              .html("<p>" + d.description["en-US"] + "</p>");
          })
          .on("mouseout", function(d, i) {
            tooltip.style("display", "none");
            d3.select(this).attr("stroke", "none");
          });


        // Question background and text
        // ADD LABEL WRAPPING, EXAMPLE: https://bl.ocks.org/mbostock/7555321
        d3.select(this).append("rect")
          .attr("width", questionWidth)
          .attr("height", visItemHeight)
          .attr("y", (i * visItemHeight))
          .classed("visQuestionBg", true)
          .on("mousemove", function(d) {
            d3.select(this).attr("stroke", "black");
            tooltip
              .style("left", d3.event.pageX - 50 + "px")
              .style("top", d3.event.pageY - 70 + "px")
              .style("display", "inline-block")
              .html("<p>" + d.question + "</p>");
          })
          .on("mouseout", function(d, i) {
            tooltip.style("display", "none");
            d3.select(this).attr("stroke", "none");
          });

        let textHolder = d3.select(this).append("text")
          .text(d["_id"].quizQuestion)
          .classed("visQuestion", true)
          .attr("x", function(){
            return (questionWidth - d3.select(this).node().getBBox().width)/2;
          })
          .attr("y", (i * visItemHeight) + 20);
      });

      function processAnswers(choices, answers, correctChoice) {

        // Count number of answers given for each option
        let countedAnswers = answers.sort().reduce((n, val) => {
          n[val] = (n[val] || 0) + 1;
          return n;
        }, {});

        for (x = 0; x < choices.length; x++) {
          choices[x].count = (countedAnswers[choices[x].id] !== undefined) ? countedAnswers[choices[x].id] : 0;
        }

        // Sort by number of responses
        choices.sort(function(a, b) {
          if (a.count > b.count)
            return 1;
          if (a.count < b.count)
            return -1;
          return 0;
        });

        // Move correct answer to the front
        for (y = 0; y < choices.length; y++) {
          if (choices[y].id == correctChoice) {
            const temp = choices.splice(y, 1);
            choices.unshift(temp[0]);
            break;
          }
        }

        return choices;
      }
    }

    function orderByQuestion(data) {

      var temp = data.sort(function(a, b) {

        const aNum = +a["_id"].quizQuestion.replace(/\D/g, '');
        const bNum = +b["_id"].quizQuestion.replace(/\D/g, '');

        if (aNum > bNum)
          return 1;
        if (aNum < bNum)
          return -1;
        return 0;

      });

      return data;
    }
  </script>

</head>

<body>
  <h1 class="title"></h1>
  <svg></svg>
</body>

</html>
